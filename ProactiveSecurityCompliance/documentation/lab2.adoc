== Lab 2: Utilizing OpenSCAP in Satellite 6 for security scanning, auditing, and remediation

=== Goal of Lab 2
The goal of this lab is to introduce you to OpenSCAP in Satellite 6. OpenSCAP is the integrated security scanning, auditing, and remediation tool in Satellite 6.

=== Introduction
Security compliance management is the ongoing process of defining security policies, auditing for compliance with those policies and resolving instances of non-compliance. Once a security policy is defined, an audit is conducted to verify compliance with the policy. Any non-compliance is managed according to the organization's configuration management policies. Security policies vary in their scope, from being host-specific to industry-wide, so there is a need for flexibility in their definition.

The Security Content Automation Protocol (SCAP) enables the definition of security configuration policies. For example, a security policy might specify that for hosts running Red Hat Enterprise Linux, login via SSH is not permitted for the root account.

In Satellite 6, tools provided by the OpenSCAP project are used to implement security compliance auditing. For more information about OpenSCAP see the link:https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/index[Red Hat Enterprise Linux 7 Security Guide]. The Satellite web UI enables scheduled compliance auditing and reporting on all hosts under management by Red Hat Satellite.

=== Introduction to SCAP content provided in Satellite 6
Before creating a SCAP compliance policy for a host, you need SCAP content.

SCAP content is a datastream format containing the configuration and security baseline against which hosts are checked. Checklists are described in the extensible checklist configuration description format (XCCDF) and vulnerabilities in the open vulnerability and assessment language (OVAL). Checklist items, also known as rules express the desired configuration of a system item. For example, you may specify that no one can log in to a host over SSH using the root user account. Rules can be grouped into one or more profiles, allowing multiple profiles to share a rule. SCAP content consists of both rules and profiles.

You can either create SCAP content or obtain it from a vendor. Supported profiles are provided for Red Hat Enterprise Linux in the scap-security-guide package. The creation of SCAP content is outside the scope of this lab, but see the link:https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/index[Red Hat Enterprise Linux 7 Security Guide] or Red Hat Enterprise Linux 6 Security Guide for information on how to download, deploy, modify, and create your own content. The SCAP content provided with Red Hat Enterprise Linux is compliant with SCAP specification 1.2.

The default SCAP content provided with the OpenSCAP components of Satellite 6 depends on the version of Red Hat Enterprise Linux:

* On Red Hat Enterprise Linux 6, content for Red Hat Enterprise Linux 6 is installed.
* On Red Hat Enterprise Linux 7, content for both Red Hat Enterprise Linux 6 and Red Hat Enterprise Linux 7 is installed.

When you install the SCAP components in Satellite as defined in the link:https://access.redhat.com/documentation/en-us/red_hat_satellite/6.3/html/administering_red_hat_satellite/chap-red_hat_satellite-administering_red_hat_satellite-security_compliance_management/[Administering Red Hat Satellite Guide], all of the Red Hat default content will show up in Satellite so no extra steps are necessary to add the SCAP content to Satellite.  But if you had customized content that you wrote yourself or if you have a modified policy and you wanted to upload that modified version , you can do that in the Satellite UI under *Hosts → SCAP contents*.

. Take a look at the default SCAP content provided with the OpenSCAP components of Satellite 6 by navigating to *Hosts → SCAP contents*.
+
image:images/lab2-scapcontents.png[1000,1000]
+
NOTE: To save time on this lab exercise, the SCAP components in Satellite were already installed for you. This is why you are seeing the default content under *Hosts → SCAP contents*. In addition, customized content named *rhel7-custom* has also been uploaded here. The *rhel7-custom* compliance policy is a simple compliance policy that just checks to see if the AIDE package is installed.

=== Creating a SCAP compliance policy for a host
Now that you have SCAP content defined in Satellite, you can create a SCAP compliance policy for a host.

. Navigate to *Hosts → Policies* and click on *New Compliance Policy* at the top right.
+
image:images/lab2-newcompliancepolicy.png[1000,1000]
+
NOTE: A SCAP compliance policy takes one of the security profiles that are available in your SCAP content and applies it to a group of systems(as defined in your Hostgroups). You can also overwrite your SCAP content with a tailoring file. You will learn more about how to use tailoring files later in this lab exercise.

. In the *Create Policy* tab,
* For the compliance policy *Name*, type *RHEL7_Standard*.
* For the *Description*, type *RHEL7 Standard System Compliance Policy*.
* Click *Next*.
+
image:images/lab2-createpolicy.png[1000,1000]

. In the *SCAP Content* tab,
* For *SCAP Content*, choose the *Red Hat rhel7 default content*.
* For *XCCDF Profile*, choose *Standard System Security Profile*.
* Do not select anything for *Tailoring File*. We will add a tailoring file later and skip this step for now.
+
NOTE: Satellite 6.3 introduced the Tailoring Files feature. Tailoring Files allow existing OpenSCAP policies to be tailored, or customized, without forking or rewriting the policy. It is important to note that the Tailoring files feature does not provide the abililty to create tailoring files. A Tailoring file can be created using SCAP Workbench(which is included in Red Hat Enterprise Linux). Once you have a Tailoring file you can upload it and assign the Tailoring File to a policy.

* Click *Next*.
+
image:images/lab2-scapcontent.png[1000,1000]

. In the *Schedule* tab,
* For *Period*, choose *Weekly*.
* For *Weekday* choose *Thursday*.
+
NOTE: Whatever is defined here as a schedule is executed as a cron job on the client. For Period, if you selected Custom, you can define normal cron syntax to define when the schedule is going to run.
* Click *Next*.
+
image:images/lab2-schedule.png[1000,1000]

. In the *Locations* tab,
* Click the *Default Location* to move it over to the *Selected items* box. This will associate the compliance policy with this Location.
* Click *Next*.
+
image:images/lab2-locations.png[1000,1000]

. In the *Organizations* tab,
* (If not already on the right) Click the *Default Organization* to move it over to the *Selected items* box. This will associate the compliance policy with this *Organization*.
* Click *Next*.
+
image:images/lab2-organizations.png[1000,1000]

. In the *Hostgroups* tab,
* Click *base_with_puppet_75* to move it over to the *Selected items* box. The compliance policy will apply to this selected *Hostgroup*.
+
NOTE: Hostgroups are groupings of systems that are built and configured the same. You can use Hostgroups as a means to roll out certain compliance policies to certain subsets of your systems.

. Click *Submit*.
+
image:images/lab2-hostgroups.png[1000,1000]

=== Executing the compliance policy scan on a host
. Now that you have defined SCAP compliance policies in Satellite,
you can go ahead and run a SCAP compliance policy scan on a host. Navigate to *Hosts -> All hosts*
+
image:images/lab2-hostsallhosts.png[1000,1000]

. Next, put a check mark next to *lab2-vm1.example.com*. This is a RHEL 7.5 pre-provisioned host that you will execute a SCAP compliance policy scan on. Then, at the top right, navigate to *Select Action -> Schedule Remote Job*.
+
image:images/lab2-scheduleremotejob.png[1000,1000]

. Now, for *Job Category* , select *Puppet*. Then, notice that for *Job template*, *Puppet Run Once - SSH Default* is automatically selected for you. Leave everything else as is. Press *Submit*.
+
image:images/lab2-puppet.png[1000,10000]

+
NOTE: This is the equivalent to running puppet agent --test. This will set up all the SCAP components, which are delivered via the puppet agent.  Satellite provides a puppet module and a means for the puppet module to set up all the SCAP components. Normally, in production, the puppet agent run automatically occurs within 30 mins so the puppet agent --test is not necessary. We are just doing this in the lab to avoid waiting 30 mins for the puppet agent to run.

. Now that the SCAP components are installed, configured on the client, and Satellite knows about all the SCAP compliance policies, let's execute a SCAP compliance policy scan on *lab2-vm1.example.com*.
Navigate to *Hosts -> All hosts* again. Then, put a check mark next to *lab2-vm1.example.com*. At the top right, navigate to *Select Action -> Schedule Remote Job*.
+
image:images/lab2-hostsallhosts.png[1000,1000]
+
image:images/lab2-scheduleremotejob.png[1000,1000]

. This time under *Job Category*, select *OpenSCAP*. Then, notice that for *Job template*, *Run OpenSCAP scans* is automatically selected for you. Leave everything else as is. Press *Submit*.
+
image:images/lab2-openscapscan.png[1000,1000]

. Notice that 5 SCAP compliance policy scans are being executed on this *lab2-vm1.example.com* host. This host is part of the *base_with_puppet_75* Hostgroup and all 5 SCAP compliance policies have been configured to include the *base_with_puppet_75* Hostgroup. As a result, all 5 SCAP compliance policies are being executed on this host.
+
image:images/lab2-jobinvocation.png[1000,1000]

. Click on the *Hosts* tab. Wait for the *Status* column to say *success*. Once the *Status* column says *success*, click on *lab2-vm1.example.com* in the *Hosts* column.
+
image:images/lab2-hostsuccess.png[1000,1000]

 . Here you can see the output from the successful run with *Exit status: 0*. This is the command line output from the client itself and can be useful for debugging purposes in the event the job fails.
Notice in this output that the results of the SCAP compliance scans are uploaded and the reports of the scans will be automatically created for you.
+
image:images/lab2-exitstatus0.png[1000,1000]

. Click on the *Back to Job* button at the top right.
+
image:images/lab2-backtojob.png[1000,1000]

. You are now back at the *Overview* page for the OpenSCAP scan that you ran on the *lab2-vm1.example.com* host. Notice again that the OpenSCAP scan on this host completed with 100% Success.
+
image:images/lab2-successcircle.png[1000,1000]

=== View the SCAP scan results report in Satellite 6
. Now let's view the SCAP scan results reports for the host, *lab2-vm1.example.com*. Navigate to *Hosts → Reports*.
+
image:images/lab2-hostreports.png[600,600]

. Notice that there are 5 Compliance reports for the 5 SCAP compliance policies (RHEL7_Standard, RHEL7_PCI_DSS, rhel7-custom, RHEL7_Common, and rhel7-base) that were executed on this host.
+
image:images/lab2-5scapreportsresults.png[1000,1000]

. Click on the report for the RHEL7_Standard Policy by clicking the link in the second *Reported At* column.
+
image:images/lab2-reportedat.png[1000,1000]

. In this report, you can see the security rules that have passed and failed at a high level which allows you to see the security posture of a system based upon an assigned audit policy.

. To see the detailed full report, click on *View full report* at the top right.
+
image:images/lab2-viewfullreport.png[1000,1000]

. Glance through this report to see what rules passed/failed, severity of the rules, etc.  Notice that you can click on each rule for a deeper drill down.

. *Click the back arrow* on your web browser to go back to the previous report summary page.
+
image:images/lab2-backarrowreport.png[500,500]

. Take a look at the top right buttons in the Satellite UI. Notice also that you can *Download the XML* of the report in bzip or HTML as well. *Click the Back button* from the top right of the Satellite UI.
+
image:images/lab2-downloadxml.png[1000,1000]

. Navigate back to *Hosts -> Reports*
+
image:images/lab2-hostreports.png[600,600]

. Notice the search bar at the top of the Satellite UI. Here, you can filter the compliance reports search with various filters. *Type compliance_failed > 0 and press Search.* This will find any compliance report that have greater than 0 compliance failures.
+
image:images/lab2-compliancefailedfilter.png[1000,1000]

=== Fix a specific SCAP scan failure, re-run the SCAP scan, and view the resulting scan report in Satellite 6
. blah



=== Scanning a host using a custom security profile using a SCAP tailoring file
. blah

=== Viewing the global status indicator in Satellite 6


<<top>>

link:README.adoc#table-of-contents[ Table of Contents ] | link:lab3.adoc[ Lab 3]
