---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Addresses maintenance plan 34923 (REPL Security Logging playbook)
# https://access.redhat.com/insights/planner/34923
# Generated by Red Hat Insights on Wed, 11 Apr 2018 14:32:59 GMT

- name: run insights to obtain latest report info
  hosts: ic1.summit.example.com,ic4.summit.example.com
  become: True
  tasks:
    - name: determine insights version
      shell: 'redhat-access-insights --version'
      changed_when: false
      register: insights_version

    - when: insights_version.stdout[0:2] != '1.'
      block:
        - name: obtaining insights report
          shell: 'redhat-access-insights --to-json --quiet'
          register: insights_result
          changed_when: false
          check_mode: false
        - name: register insights report as fact for use by other plays
          set_fact: insights_report={{ insights_result.stdout }}

    - when: insights_version.stdout[0:2] == '1.'
      block:
        - name: obtaining insights report (legacy client)
          shell: 'redhat-access-insights --verbose | grep "Upload status: 201 Created" | grep -o "{.*}"'
          register: insights_result_legacy
          changed_when: false
          check_mode: false
        - name: register insights report as fact for use by other plays (legacy client)
          set_fact: insights_report={{ insights_result_legacy.stdout }}

# Decreased security in system logging permissions
# Identifier: (hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS,105,default_perms)
# Version: 18ca8be1371d1c196cbad89c61db229616bb5412
- name: Fix hardening_logging_log_perms issue
  hosts: "ic1.summit.example.com,ic4.summit.example.com"
  become: true
  vars:
    pydata: '{{insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"]}}'
    perms:
      "/var/log":           { owner: "root", group: "root", mode: "u=rw,o-w" }
      "/var/log/wtmp":      { owner: "root", group: "utmp", mode: "u=rw,g-x,o-wx" }
      "/var/log/btmp":      { owner: "root", group: "utmp", mode: "u=rw,g-rwx,o-rwx" }
      "/var/log/audit":     { owner: "root", group: "root", mode: "u=rw,o-rwx" }
      "/var/log/boot.log":  { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/dmesg":     { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/lastlog":   { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/messages":  { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/spooler":   { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/tallylog":  { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/yum.log":   { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/cron":      { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }
      "/var/log/maillog":   { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }
      "/var/log/secure":    { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }

  tasks:
  - when: insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"] is defined
    block:
    - name: Set the correct permissions on affected log files
      file:
        path: "{{item.log_perms_dirfilename}}"
        owner: "{{perms[item.log_perms_dirfilename]['owner']}}"
        group: "{{perms[item.log_perms_dirfilename]['group']}}"
        mode: "{{perms[item.log_perms_dirfilename]['mode']}}"
      with_items: "{{pydata.detected_problem_log_perms}}"


- name: run insights
  hosts: ic1.summit.example.com,ic4.summit.example.com
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: redhat-access-insights
      changed_when: false